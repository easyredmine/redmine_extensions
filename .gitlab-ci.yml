# This file is generated by GitLab CI
before_script:
  - export HOME=/home/gitlab_ci_multi_runner
  - export LC_ALL=en_US.UTF-8
  - export PATH=$HOME/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
  - ''
  - source /usr/local/rvm/scripts/rvm > /dev/null 2>&1


Ruby 2.1.2 Pure Redmine / MySQL:
  script:
  - rvm use ruby 2.1.2 > /dev/null 2>&1
  - ''
  - ruby -v
  - ''
  - cp config/database.yml.mysql spec/redmine/config/database.yml
  - sed "s/redmine/redmine_test_$((RANDOM))/" -i spec/redmine/config/database.yml
  - ''
  - bundle install
  - bundle exec rake db:drop
  - bundle exec rake db:create
  - bundle exec rake db:migrate
  - bundle exec rake redmine_test
  - bundle exec rake spec
  - bundle exec rake db:drop
  tags:
  except:
  - master

Ruby 2.1.2 EasyRedmine / MySQL:
  script:
  - rvm use ruby 2.1.2 > /dev/null 2>&1
  - ''
  - ruby -v
  - ''
  - rm -rf spec/redmine
  - git clone https://$GITLAB_FETCH_USER:$GITLAB_FETCH_PASSWORD@git.easy.cz/easyproject/stable-2014.git spec/redmine
  - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
  - 'sed ''s/pattern = "\.\/plugins/pattern = "#{Rails.root}\/plugins/'' -i spec/redmine/plugins/easyproject/easy_plugins/easy_extensions/lib/tasks/tests.rake'
  - ''
  - cp config/database.yml.mysql spec/redmine/config/database.yml
  - sed "s/redmine/redmine_test_$((RANDOM))/" -i spec/redmine/config/database.yml
  - ''
  - bundle install
  - bundle exec rake db:drop
  - bundle exec rake db:create
  - bundle exec rake db:migrate
  - bundle exec rake app:redmine:plugins:migrate
  - bundle exec rake app:easyproject:tests:spec
  - bundle exec rake spec
  - bundle exec rake db:drop

#  - bundle exec rake test:prepare RAILS_ENV=test
#  - bundle exec rake easyproject:tests:spec RAILS_ENV=test
  tags:
  except:
  - master
