# This file is generated by GitLab CI
stages:
  - linter
  - spec
  - tests

before_script:
  - export HOME=/home/gitlab-runner
  - export LC_ALL=en_US.UTF-8
  - ''
  - export BRANCH=devel
  - ''
  - rvm use ruby 2.4.2 > /dev/null 2>&1
  - ruby -v
  - export REDMINE_SUBDIR="spec/redmine"
  - export REDMINE_VERSION="3.4-stable"
  - export REDMINE_REPO="https://github.com/redmine/redmine.git"
  - export EASY_REPO="ssh://git@git.easy.cz/easyredmine/devel-2016.git"

Check syntax error:
  stage: linter
  script:
  - $SHELL ./.run-linter.sh

Spec / MySQL:
  stage: spec
  script:
  - export ADAPTER="mysql2"
  - export DB_USERNAME="root"
  - export DB_PWD=$MYSQL_PASS
  - export ONLY_SPEC='true'
  - git clone --depth 1 $REDMINE_REPO -b $REDMINE_VERSION spec/redmine
  - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
  - $SHELL ./.run-tests.sh
  except:
  - master

Spec / Postgresql:
  stage: spec
  script:
  - export ADAPTER="postgresql"
  - export DB_USERNAME="postgres"
  - export DB_PWD=""
  - export ONLY_SPEC='true'
  - git clone --depth 1 $REDMINE_REPO -b $REDMINE_VERSION spec/redmine
  - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
  - $SHELL ./.run-tests.sh
  except:
  - master

Pure Redmine / MySQL:
  stage: tests
  allow_failure: true
  script:
  - export ADAPTER="mysql2"
  - export DB_USERNAME="root"
  - export DB_PWD=$MYSQL_PASS
  - git clone --depth 1 $REDMINE_REPO -b $REDMINE_VERSION spec/redmine
  - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
  - $SHELL ./.run-tests.sh
  except:
  - master

Pure Redmine / Postgresql:
  stage: tests
  allow_failure: true
  script:
  - export ADAPTER="postgresql"
  - export DB_USERNAME="postgres"
  - export DB_PWD=""
  - git clone --depth 1 $REDMINE_REPO -b $REDMINE_VERSION spec/redmine
  - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
  - $SHELL ./.run-tests.sh
  except:
  - master

Easy Redmine Fast / Mysql:
   stage: tests
   script:
   - rm -rf spec/redmine
   - git clone --depth 1 $EASY_REPO spec/redmine
   - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
   - export EASY='true'
   - export ADAPTER="mysql2"
   - export DB_USERNAME="root"
   - export DB_PWD=$MYSQL_PASS
   - export TAGS=[~slow]
   - ''
   - $SHELL ./.run-tests.sh
   except:
   - master

Easy Redmine Fast / Postgresql:
   stage: tests
   script:
   - rm -rf spec/redmine
   - git clone --depth 1 $EASY_REPO spec/redmine
   - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
   - export EASY='true'
   - export ADAPTER="postgresql"
   - export DB_USERNAME="postgres"
   - export DB_PWD=""
   - export TAGS=[~slow]
   - ''
   - $SHELL ./.run-tests.sh
   except:
   - master

Easy Redmine Slow / Mysql:
   stage: tests
   script:
   - rm -rf spec/redmine
   - git clone --depth 1 $EASY_REPO spec/redmine
   - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
   - export EASY='true'
   - export ADAPTER="mysql2"
   - export DB_USERNAME="root"
   - export DB_PWD=$MYSQL_PASS
   - export TAGS=[slow]
   - ''
   - $SHELL ./.run-tests.sh
   except:
   - master

Easy Redmine Slow / Postgresql:
   stage: tests
   script:
   - rm -rf spec/redmine
   - git clone --depth 1 $EASY_REPO spec/redmine
   - sed "s/..\/Gemfile/..\/..\/..\/Gemfile/" -i spec/redmine/config/boot.rb
   - export EASY='true'
   - export ADAPTER="postgresql"
   - export DB_USERNAME="postgres"
   - export DB_PWD=""
   - export TAGS=[slow]
   - ''
   - $SHELL ./.run-tests.sh
   except:
   - master